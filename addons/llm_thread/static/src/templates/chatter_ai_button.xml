<?xml version="1.0" encoding="utf-8" ?>
<templates>
    <!--
    Extend Chatter to add AI Chat button and inline AI chat mode
    IMPORTANT: Conditionally replaces chatter content with LLM chat interface
    -->
    <t
    t-name="llm_thread.ChatterAIExtension"
    t-inherit="mail.Chatter"
    t-inherit-mode="extension"
  >
        <!-- Add AI button before the spacer in the left buttons section -->
        <xpath
      expr="//span[hasclass('o-mail-Chatter-topbarGrow')]"
      position="before"
    >
            <!-- Toggle AI Chat button -->
            <button
        t-if="shouldShowAIButton"
        class="o-mail-Chatter-aiChat btn text-nowrap ms-1 me-1"
        t-att-class="{
            'btn-primary': state.isChattingWithLLM,
            'my-2': !props.compactHeight
        }"
        type="button"
        t-on-click="onAIChatClick"
        t-att-title="state.isChattingWithLLM ? 'Exit AI Chat' : 'Start AI Chat'"
      >
                <i class="fa fa-robot me-1" role="img" aria-label="AI Chat" />
                <span
          class="d-none d-sm-inline"
          t-esc="state.isChattingWithLLM ? 'Exit AI' : 'AI'"
        />
            </button>
        </xpath>

        <!-- Replace chatter content with LLM chat when active -->
        <xpath
      expr="//div[hasclass('o-mail-Chatter-content')]"
      position="replace"
    >
            <div class="o-mail-Chatter-content d-flex flex-column flex-grow-1">
                <t t-if="state.isChattingWithLLM">
                    <!-- AI Chat Mode: Show LLM chat interface with filtered conversation list -->
                    <LLMChatContainer
            recordModel="props.threadModel"
            recordId="props.threadId"
          />
                </t>
                <t t-else="">
                    <!-- Normal Mode: Show original chatter content -->
                    <t
            t-if="props.has_activities and activities.length and !messageSearch.searching and !messageSearch.searched"
          >
                        <t t-call="mail.ActivityList" />
                    </t>
                    <t t-if="scheduledMessages.length">
                        <t t-call="mail.ScheduledMessagesList" />
                    </t>
                    <div
            t-if="state.isAttachmentBoxOpened"
            class="o-mail-AttachmentBox position-relative"
          >
                        <div class="d-flex align-items-center">
                            <hr class="flex-grow-1" />
                            <span class="p-3 fw-bold">Files</span>
                            <hr class="flex-grow-1" />
                        </div>
                        <div class="d-flex flex-column">
                            <AttachmentList
                attachments="attachments"
                unlinkAttachment.bind="unlinkAttachment"
                imagesHeight="100"
              />
                            <FileUploader
                multiUpload="true"
                fileUploadClass="'o-mail-Chatter-fileUploader'"
                onUploaded.bind="onUploaded"
                onClick="(ev) => this.onClickAttachFile(ev)"
              >
                                <t t-set-slot="toggler">
                                    <button
                    class="btn btn-link"
                    type="button"
                    t-att-disabled="!state.thread.hasWriteAccess"
                  >
                                        <i class="fa fa-plus-square" />
                                        Attach files
                                    </button>
                                </t>
                            </FileUploader>
                        </div>
                    </div>
                    <SearchMessageResult
            t-if="messageSearch.searching or messageSearch.searched"
            thread="state.thread"
            messageSearch="messageSearch"
            onClickJump.bind="closeSearch"
          />
                    <Thread
            t-else=""
            thread="state.thread"
            t-key="state.thread.localId"
            order="'desc'"
            scrollRef="rootRef"
            jumpPresent="state.jumpThreadPresent"
          />
                </t>
            </div>
        </xpath>
    </t>
</templates>
